<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion-Tracking Smart Hockey Stick</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <header class="header">
        <div class="title"><h1>Motion-Tracking Smart Hockey Stick</h1></div>
        <nav>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0)">Weekly Progress â–¼</a>
                    <ul class="dropdown-content">
                        <li><a href="week1.html">Week 1</a></li>
                        <li><a href="week2.html">Week 2</a></li>
                        <li><a href="week3.html">Week 3</a></li>
                        <li><a href="week4.html">Week 4</a></li>
                    </ul>
                </li>
                <li><a href="about.html">Demonstration Video</a></li>
            </ul>
        </nav>
    </header>

    <main class="dashboard-wrapper">
        <div class="status-container">
            <span id="connection-status" style="color: #FF2E63;">ðŸ”´ OFFLINE (Showing Last Saved Data)</span>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">
                <h2>Current Speed: <span class="highlight" id="val-speed">0.0 km/h</span></h2>
            </div>
            <div class="kpi-card">
                <h2>Total Distance: <span class="highlight" id="val-dist">0.00 km</span></h2>
            </div>
            <button onclick="downloadCSV()" class="download-btn">ðŸ“¥ Download Session</button>
        </div>

        <div class="dashboard-grid">
            <div class="map-card">
                <h3>GPS Tracking Route</h3>
                <div id="map"></div>
            </div>

            <div class="charts-stack">
                <div class="chart-card">
                    <h3>Skating Speed (km/h)</h3>
                    <div class="canvas-container"><canvas id="speedChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>3-Axis Acceleration (m/sÂ²)</h3>
                    <div class="canvas-container"><canvas id="accelChart"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const PICO_IP = "http://172.29.171.30/data";
        const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

        let stickData = JSON.parse(localStorage.getItem('stickMemory')) || {
            labels: [], speed: [], x: [], y: [], z: [], lastSpeed: 0, lastDist: 0
        };

        // --- Chart Configuration ---
        Chart.defaults.color = '#8b949e';
        Chart.defaults.borderColor = '#30363d';

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            elements: { point: { radius: 0 } },
            scales: {
                x: {
                    display: true,
                    title: { display: true, text: 'Time (s)', font: { weight: 'bold' } },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                }
            }
        };

        const speedChart = new Chart(document.getElementById('speedChart'), {
            type: 'line',
            data: {
                labels: stickData.labels,
                datasets: [{ label: 'Speed', borderColor: '#7289FF', borderWidth: 2, data: stickData.speed }]
            },
            options: { ...commonOptions, scales: { ...commonOptions.scales, y: { min: 0, max: 50 } } }
        });

        const accelChart = new Chart(document.getElementById('accelChart'), {
            type: 'line',
            data: {
                labels: stickData.labels,
                datasets: [
                    { label: 'Ax', borderColor: '#FF2E63', data: stickData.x },
                    { label: 'Ay', borderColor: '#00ffcc', data: stickData.y },
                    { label: 'Az', borderColor: '#F1E05A', data: stickData.z }
                ]
            },
            options: { ...commonOptions, scales: { ...commonOptions.scales, y: { min: -30, max: 30 } } }
        });

        // --- Map Logic ---
        const map = L.map('map').setView([53.404, -2.968], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const stickMarker = L.circleMarker([53.404, -2.968], { color: '#00ffcc', radius: 8 }).addTo(map);

        function parseNMEA(nmeaStr) {
            if (!nmeaStr || nmeaStr === "0.0") return null;
            let dir = nmeaStr.slice(-1);
            let valStr = nmeaStr.slice(0, -1);
            let deg = parseInt(valStr.slice(0, valStr.indexOf('.') - 2)) || 0;
            let min = parseFloat(valStr.slice(valStr.indexOf('.') - 2)) || 0;
            let decimal = deg + (min / 60);
            return (dir === 'S' || dir === 'W') ? -decimal : decimal;
        }

        // --- Data Loop ---
        setInterval(async () => {
            try {
                const response = await fetch(PICO_IP, { signal: AbortSignal.timeout(2000) });
                const data = await response.json();

                const statusEl = document.getElementById('connection-status');
                statusEl.innerText = "ðŸŸ¢ LIVE";
                statusEl.style.color = "#00ffcc";

                document.getElementById('val-speed').innerText = data.speed.toFixed(1) + " km/h";
                document.getElementById('val-dist').innerText = data.dist.toFixed(2) + " km";

                if (stickData.labels.length > 50) {
                    ['labels', 'speed', 'x', 'y', 'z'].forEach(key => stickData[key].shift());
                }

                stickData.labels.push(data.time.toFixed(0));
                stickData.speed.push(clamp(data.speed, 0, 50));
                stickData.x.push(clamp(data.x, -30, 30));
                stickData.y.push(clamp(data.y, -30, 30));
                stickData.z.push(clamp(data.z, -30, 30));

                speedChart.update();
                accelChart.update();

                let lat = parseNMEA(data.lat);
                let lon = parseNMEA(data.lon);
                if (lat && lon) {
                    let pos = [lat, lon];
                    stickMarker.setLatLng(pos);
                    map.panTo(pos);
                }
                localStorage.setItem('stickMemory', JSON.stringify(stickData));
            } catch (e) {
                document.getElementById('connection-status').innerText = "ðŸ”´ OFFLINE (Showing Last Saved Data)";
                document.getElementById('connection-status').style.color = "#FF2E63";
            }
        }, 1000);

        function downloadCSV() {
            let csv = "Time_s,Speed_kmh,Ax,Ay,Az\n";
            stickData.labels.forEach((l, i) => {
                csv += `${l},${stickData.speed[i]},${stickData.x[i]},${stickData.y[i]},${stickData.z[i]}\n`;
            });
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = 'hockey_data.csv';
            link.click();
        }
    </script>
</body>
</html>